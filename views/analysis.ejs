<%- include("partials/navbar.ejs") %>

<style>
  a {
    text-decoration: none;
    color: inherit;
  }
  
  .highlight {
    color: #FF0000;
  }
  
  .lead {
    color: #cccccc;
    max-width: 700px;
    margin: 0 auto;
  }
  
  .form-box {
    background-color: #181818;
    width: 100%;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 15px 30px rgba(255, 0, 0, 0.2);
  }
  
  .input-group {
    display: flex;
    flex-wrap: nowrap;
    border-radius: 12px;
    overflow: hidden;
    background-color: #1F1F1F;
    box-shadow: inset 0 0 0 2px #FF0000;
  }
  
  .form-control {
    flex-grow: 1;
    border: none;
    background-color: #1F1F1F;
    padding: 16px 20px;
    font-size: 1rem;
    color: #ffffff;
  }
  
  .form-control::placeholder {
    color: #888888;
  }
  
  .form-control:focus {
    outline: none;
    background-color: #1F1F1F;
    color: #fff;
  }
  
  .btn-danger {
    background-color: #FF0000;
    border: none;
    padding: 0 24px;
    color: #fff;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  
  .btn-danger:hover {
    background-color: #b91212;
  }
  
  .text-muted {
    color: #aaaaaa !important;
  }
  
  #info-section {
    margin-top: 80px;
    padding: 40px 20px;
    background: #121212;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    animation: fadeIn 1s ease forwards;
  }
  
  .info-box {
    background: #1c1c1e;
    border-radius: 16px;
    padding: 30px 20px;
    transition: transform 0.4s ease, box-shadow 0.4s ease;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
    height: 100%;
  }
  
  .info-box:hover {
    transform: translateY(-10px);
    box-shadow: 0 0 20px 4px rgba(255, 0, 0, 0.4);
  }
  
  .info-box .emoji {
    font-size: 3rem;
    margin-bottom: 20px;
  }
  
  .info-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #f5f5f5;
    margin-bottom: 15px;
  }
  
  .info-text {
    font-size: 1rem;
    color: #ccc;
    line-height: 1.6;
  }
  
  #wordclouds-container {
    margin-top: 80px;
    text-align: center;
    padding: 20px;
    animation: fadeIn 1s ease forwards;
  }
  
  #wordclouds-title {
    font-size: 2.8rem;
    font-weight: 700;
    margin-bottom: 50px;
    color: #ffffff;
    text-shadow: 2px 2px 12px rgba(255, 255, 255, 0.3);
  }
  
  #wordclouds {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 30px;
    justify-items: center;
    padding: 0 20px;
  }
  
  .wordcloud-card {
    background: #1c1c1e;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
    transition: transform 0.4s ease, box-shadow 0.4s ease;
    width: 100%;
    max-width: 320px;
  }
  
  .wordcloud-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 0 25px 5px rgba(255, 0, 0, 0.4);
  }
  
  .wordcloud-card h4 {
    margin-bottom: 15px;
    font-size: 1.5rem;
    font-weight: bold;
    color: #f5f5f5;
  }
  
  .wordcloud-card img {
    width: 100%;
    height: auto;
    border-radius: 10px;
    border: 1px solid #555;
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .wordcloud-card img:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
  }
  
  @media (max-width: 768px) {
    .input-group {
      flex-direction: column;
      border-radius: 12px;
    }
  
    .form-control {
      border-radius: 12px 12px 0 0;
    }
  
    .btn-danger {
      border-radius: 0 0 12px 12px;
      width: 100%;
    }
  
    .info-box {
      padding: 20px;
    }
  
    .info-title {
      font-size: 1.6rem;
    }
  
    .info-text {
      font-size: 0.9rem;
    }
  
    #wordclouds-title {
      font-size: 2rem;
    }
  
    .wordcloud-card {
      max-width: 280px;
    }
  
    .wordcloud-card h4 {
      font-size: 1.4rem;
    }
  
    .wordcloud-card img {
      max-height: 250px;
    }
  }
  
  @media (max-width: 576px) {
    .input-group {
      flex-direction: column;
      border-radius: 12px;
    }
  
    .form-control {
      border-radius: 12px 12px 0 0;
    }
  
    .btn-danger {
      border-radius: 0 0 12px 12px;
      width: 100%;
    }
  
    .info-box {
      padding: 15px;
    }
  
    .info-title {
      font-size: 1.4rem;
    }
  
    .info-text {
      font-size: 0.85rem;
    }
  
    #wordclouds-title {
      font-size: 1.8rem;
    }
  
    .wordcloud-card {
      max-width: 260px;
    }
  
    .wordcloud-card h4 {
      font-size: 1.2rem;
    }
  
    .wordcloud-card img {
      max-height: 200px;
    }
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
</style>  

<section class="analysis-hero text-center text-light py-5">
  <div class="container">
    <h1 class="display-5 fw-bold mb-3">Analyze Your <span class="highlight">YouTube Video</span></h1>
    <p class="lead">Uncover how your audience really feels. Get instant sentiment, tone, and insight using AI-powered feedback analysis.</p>
  </div>
</section>

<section class="analysis-form-section py-5">
  <div class="container">
    <div class="row justify-content-center align-items-center">
      <div class="col-lg-8">
        <div class="form-box p-4">
          <h3 class="text-center mb-4">üîç Enter YouTube Video Link or ID</h3>
          <form id="analyzeForm">
            <div class="row g-2 mb-3">
              <div class="col-12 col-md-9">
                <input
                  type="text"
                  class="form-control form-control-lg"
                  id="videoInput"
                  placeholder="e.g. https://www.youtube.com/watch?v=VIDEO_ID"
                  required
                />
              </div>
              <div class="col-12 col-md-3 d-grid">
                <button type="submit" class="btn btn-danger btn-lg w-100">
                  Analyze
                </button>
              </div>
            </div>
            <p class="text-muted text-center small">
              We'll fetch the top 200 comments and use AI to break down the response.
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="loader" class="text-center mt-4" style="display:none;">
    <div class="spinner-border text-danger" role="status"></div>
    <p class="mt-2 text-light">Analyzing comments, please wait...</p>
  </div>

  <div id="resultsSection" class="mt-5 text-center text-light" style="display:none;">
    <h2 id="wordclouds-title">üìä Comment Classification Results</h4>
    <div style="max-width: 400px; margin: 0 auto;">
      <canvas id="categoryChart" width="400" height="400"></canvas>
    </div>    
    <div class="mt-4">
      <a id="downloadLink"
         class="btn btn-outline-light"
         href="#"
         download="batch_predictions.csv"
         style="display: none; padding: 10px 20px; border: 1px solid #fff; border-radius: 5px; color: #ffffff; text-decoration: none; transition: color 0.3s, background-color 0.3s; cursor: pointer;"
         onmouseover="this.style.color='white'; this.style.backgroundColor='red';"
         onmouseout="this.style.color='white'; this.style.backgroundColor='transparent';">
        Download CSV
      </a>
    </div>
  </div>

  <!-- wordclouds -->
  <div id="wordclouds-container" style="margin-top: 40px; display: none;">
    <h2 id="wordclouds-title">WordClouds</h2>
    <div id="wordclouds"></div>
  </div>
  
<!-- info section -->
<div id="info-section" class="container my-5">
  <div class="row gy-5 text-center">
    
    <div class="col-md-4">
      <div class="info-box">
        <div class="emoji">üìä</div>
        <h5 class="info-title">Better Understanding</h5>
        <p class="info-text">Dive deep into content creation by understanding the users.</p>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="info-box">
        <div class="emoji">üó£Ô∏è</div>
        <h5 class="info-title">Comment Detection</h5>
        <p class="info-text">Uncover the hidden insights: doubts or feedback in comments.</p>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="info-box">
        <div class="emoji">üìå</div>
        <h5 class="info-title">Top Insights</h5>
        <p class="info-text">Based on different metrics, get to know if your platform is investable or not.</p>
      </div>
    </div>

  </div>
</div>

</section>

<!-- pie chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.getElementById("analyzeForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    
    const videoInput = document.getElementById("videoInput").value.trim();
    const videoID = extractVideoId(videoInput);

    if (!videoID) {
      alert("Please enter a valid YouTube video link or ID.");
      return;
    }

    document.getElementById("loader").style.display = "block";
    document.getElementById("resultsSection").style.display = "none";
    document.getElementById("downloadLink").style.display = "none";

    try {
      const response = await fetch("https://socialsense-jhmp.onrender.com/predict", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ video_link: `https://www.youtube.com/watch?v=${videoID}` })
      });

      const data = await response.json();

      if (data.error) {
        alert("Error: " + data.error);
        document.getElementById("loader").style.display = "none";
        return;
      }

      const { breakdown, download_link, wordclouds } = data;
      showChart(breakdown);
      renderWordClouds(wordclouds); 
      

      const link = document.getElementById("downloadLink");
      link.href = `https://socialsense-jhmp.onrender.com${download_link}`;
      link.setAttribute("download", "batch_predictions.csv");
      link.style.display = "inline-block";

      document.getElementById("loader").style.display = "none";
      document.getElementById("resultsSection").style.display = "block";

    } catch (error) {
      console.error("Error:", error);
      alert("Something went wrong. Please try again.");
      document.getElementById("loader").style.display = "none";
    }
  });

  function extractVideoId(url) {
    const regex = /(?:v=|\/)([0-9A-Za-z_-]{11})/;
    const match = url.match(regex);
    return match ? match[1] : (url.length === 11 ? url : null);
  }

  let chartInstance;

  function showChart(distribution) {
    const ctx = document.getElementById("categoryChart").getContext("2d");
    const labels = Object.keys(distribution);
    const values = Object.values(distribution);
    const colors = ["#f94144", "#277da1", "#f9c74f", "#43aa8b", "#f3722c", "#577590"];

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: colors,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: 'white'
            }
          }
        }
      }
    });
  }

  function renderWordClouds(wordclouds) {
    const wordcloudsContainer = document.getElementById('wordclouds-container');
    const wordcloudsDiv = document.getElementById('wordclouds');
    
    wordcloudsDiv.innerHTML = '';

    if (!wordclouds || Object.keys(wordclouds).length === 0) {
        wordcloudsContainer.style.display = 'none';
        return;
    }

    wordcloudsContainer.style.display = 'block';

    for (const label in wordclouds) {
        const container = document.createElement('div');
        container.className = 'wordcloud-card';

        const title = document.createElement('h4');
        title.textContent = label;

        const img = document.createElement('img');
        img.src = `https://socialsense-jhmp.onrender.com${wordclouds[label]}`;
        img.alt = label;

        container.appendChild(title);
        container.appendChild(img);
        wordcloudsDiv.appendChild(container);
    }
}
</script>

<%- include("partials/footer.ejs") %>
